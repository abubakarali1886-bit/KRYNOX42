<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>KRYNOX42 ¬∑ Chemistry AI</title>
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <style>
        /* ---------- MODERN CSS RESET & VARIABLES ---------- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --font-sans: 'Inter', -apple-system, system-ui, sans-serif;
            
            /* Premium Black & Grey Theme */
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-tertiary: #2d2d2d;
            --bg-elevated: #333333;
            --border-light: #3a3a3a;
            --border-focus: #666666;
            --text-primary: #ffffff;
            --text-secondary: #e0e0e0;
            --text-tertiary: #a0a0a0;
            --accent-primary: #4a4a4a;
            --accent-secondary: #5a5a5a;
            --accent-soft: #2a2a2a;
            --user-bubble: #2c2c2c;
            --user-bubble-text: #ffffff;
            --bot-bubble: #1a1a1a;
            --bot-bubble-text: #f0f0f0;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.5);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.6);
            --shadow-lg: 0 10px 25px -5px rgba(0,0,0,0.7);
            --shadow-xl: 0 20px 30px -10px rgba(0,0,0,0.8);
            --sidebar-width: 300px;
            --sidebar-width-mobile: 85vw;
            --header-height: 70px;
        }

        /* Override for light mode - keep premium greyscale */
        [data-theme="light"] {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #ebebeb;
            --bg-elevated: #e0e0e0;
            --border-light: #d1d1d1;
            --border-focus: #9e9e9e;
            --text-primary: #1a1a1a;
            --text-secondary: #4a4a4a;
            --text-tertiary: #6b6b6b;
            --accent-primary: #6b6b6b;
            --accent-secondary: #7a7a7a;
            --accent-soft: #e8e8e8;
            --user-bubble: #3a3a3a;
            --user-bubble-text: #ffffff;
            --bot-bubble: #f0f0f0;
            --bot-bubble-text: #1a1a1a;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.12);
            --shadow-lg: 0 10px 25px -5px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 30px -10px rgba(0,0,0,0.15);
        }

        body {
            font-family: var(--font-sans);
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            transition: background 0.2s ease, color 0.2s ease;
            line-height: 1.5;
            font-size: 14px;
        }

        /* ---------- MAIN LAYOUT ---------- */
        .app {
            display: flex;
            height: 100vh;
            width: 100vw;
            position: relative;
        }

        /* ---------- MENU BUTTON - TOP LEFT ---------- */
        .menu-button {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 48px;
            height: 48px;
            border-radius: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-md);
            backdrop-filter: blur(8px);
        }

        .menu-button:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border-color: var(--border-focus);
            transform: scale(1.02);
        }

        /* ---------- SIDEBAR (CHAT HISTORY) ---------- */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: var(--sidebar-width);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            z-index: 999;
            transform: translateX(-100%);
            box-shadow: var(--shadow-xl);
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 28px 24px 20px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            border-bottom: 1px solid var(--border-light);
        }

        .sidebar-header .logo {
            width: 40px;
            height: 40px;
            background: var(--bg-elevated);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            font-size: 1.3rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
        }

        .sidebar-header h1 {
            font-size: 1.3rem;
            font-weight: 600;
            letter-spacing: -0.01em;
            color: var(--text-primary);
        }

        .new-chat-btn {
            margin: 20px 24px;
            padding: 14px 20px;
            background: var(--bg-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
            border-radius: 40px;
            font-weight: 500;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }

        .new-chat-btn:hover {
            background: var(--accent-primary);
            border-color: var(--border-focus);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .new-chat-btn i {
            font-size: 1rem;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 8px 16px 12px 24px;
        }

        .chat-history-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 8px 12px 8px;
            color: var(--text-tertiary);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chat-history-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            position: relative;
            background: var(--bg-secondary);
        }

        .chat-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-light);
        }

        .chat-item.active {
            background: var(--bg-elevated);
            border-color: var(--border-focus);
        }

        .chat-item-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 1rem;
            flex-shrink: 0;
        }

        .chat-item-content {
            flex: 1;
            min-width: 0;
        }

        .chat-item-title {
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }

        .chat-item-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.7rem;
            color: var(--text-tertiary);
        }

        .chat-item-time {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .chat-item-delete {
            opacity: 0;
            background: transparent;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .chat-item:hover .chat-item-delete {
            opacity: 1;
        }

        .chat-item-delete:hover {
            background: var(--bg-tertiary);
            color: #ef4444;
        }

        .sidebar-footer {
            padding: 24px;
            border-top: 1px solid var(--border-light);
        }

        .theme-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            background: var(--bg-tertiary);
            border-radius: 40px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            border: 1px solid var(--border-light);
        }

        .theme-toggle button {
            width: 38px;
            height: 38px;
            border-radius: 30px;
            border: 1px solid var(--border-light);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .theme-toggle button:hover {
            background: var(--accent-primary);
            border-color: var(--border-focus);
        }

        /* ---------- SIDEBAR BACKDROP ---------- */
        .sidebar-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 998;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .sidebar-backdrop.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* ---------- MAIN CHAT AREA ---------- */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            overflow: hidden;
            margin-left: 0;
            transition: margin-left 0.3s;
        }

        .chat-header {
            padding: 20px 28px 20px 88px; /* Left padding to accommodate menu button */
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            min-height: var(--header-height);
        }

        .chat-header-info {
            flex: 1;
            min-width: 0;
        }

        .chat-header-info h2 {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-header-info h3 {
            font-size: 0.85rem;
            font-weight: 400;
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-header-info h3 i {
            font-size: 0.7rem;
            color: var(--text-tertiary);
            flex-shrink: 0;
        }

        .chat-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .chat-actions button {
            padding: 8px 16px;
            border-radius: 30px;
            border: 1px solid var(--border-light);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chat-actions button:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border-color: var(--border-focus);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 28px 32px;
            scroll-behavior: smooth;
        }

        .messages-wrapper {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .message {
            display: flex;
            gap: 16px;
            animation: fadeIn 0.3s ease;
            max-width: 100%;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: var(--text-secondary);
            flex-shrink: 0;
            border: 1px solid var(--border-light);
        }

        .user .message-avatar {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border-focus);
        }

        .message-content {
            flex: 1;
            min-width: 0;
            max-width: calc(100% - 52px);
        }

        .message-bubble {
            padding: 16px 20px;
            border-radius: 20px;
            font-size: 0.95rem;
            line-height: 1.6;
            word-break: break-word;
        }

        .user .message-bubble {
            background: var(--user-bubble);
            color: var(--user-bubble-text);
            border-bottom-right-radius: 4px;
        }

        .bot .message-bubble {
            background: var(--bot-bubble);
            color: var(--bot-bubble-text);
            border-bottom-left-radius: 4px;
            border: 1px solid var(--border-light);
        }

        .message-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 6px;
            padding: 0 8px;
            font-size: 0.7rem;
            color: var(--text-tertiary);
        }

        .user .message-meta {
            justify-content: flex-end;
        }

        .message-lang {
            background: var(--bg-tertiary);
            padding: 2px 8px;
            border-radius: 30px;
            font-size: 0.6rem;
            font-weight: 600;
            text-transform: uppercase;
            border: 1px solid var(--border-light);
        }

        .typing-indicator {
            display: flex;
            gap: 6px;
            padding: 16px 20px;
            background: var(--bot-bubble);
            border-radius: 20px;
            border-bottom-left-radius: 4px;
            border: 1px solid var(--border-light);
            width: fit-content;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--text-tertiary);
            border-radius: 50%;
            opacity: 0.6;
            animation: typingBounce 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.6; }
            30% { transform: translateY(-8px); opacity: 1; }
        }

        .input-area {
            padding: 20px 28px 28px 28px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-light);
        }

        .input-wrapper {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            gap: 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: 40px;
            padding: 4px 4px 4px 20px;
            transition: all 0.2s;
        }

        .input-wrapper:focus-within {
            border-color: var(--border-focus);
            box-shadow: var(--shadow-md);
        }

        .input-wrapper input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 14px 0;
            font-size: 0.95rem;
            color: var(--text-primary);
            outline: none;
            min-width: 0;
        }

        .input-wrapper input::placeholder {
            color: var(--text-tertiary);
        }

        .input-wrapper button {
            width: 48px;
            height: 48px;
            border-radius: 40px;
            border: none;
            background: var(--bg-elevated);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            flex-shrink: 0;
            border: 1px solid var(--border-light);
        }

        .input-wrapper button:hover:not(:disabled) {
            background: var(--accent-primary);
            border-color: var(--border-focus);
            transform: scale(1.02);
        }

        .input-wrapper button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .input-footer {
            max-width: 900px;
            margin: 10px auto 0;
            padding: 0 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            font-size: 0.7rem;
            color: var(--text-tertiary);
            flex-wrap: wrap;
        }

        .input-footer i {
            color: var(--text-tertiary);
        }

        /* Chemistry formatting */
        sub { font-size: 0.7em; vertical-align: sub; }
        .katex { font-size: 1.05em; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Scrollbar - Premium style */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-tertiary); }
        ::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--border-focus); }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-tertiary);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .empty-state p {
            font-size: 0.9rem;
            max-width: 400px;
            margin: 0 auto;
        }

        /* ---------- RESPONSIVE ---------- */
        @media (max-width: 1024px) {
            .messages-container { padding: 20px 24px; }
            .chat-header { padding: 16px 24px 16px 80px; }
            .input-area { padding: 16px 24px 24px 24px; }
        }

        @media (max-width: 768px) {
            .menu-button {
                top: 16px;
                left: 16px;
                width: 44px;
                height: 44px;
            }

            .chat-header {
                padding: 12px 20px 12px 70px;
            }

            .chat-header-info h2 { font-size: 0.95rem; }
            .chat-header-info h3 { font-size: 0.8rem; }

            .chat-actions button span { display: none; }
            .chat-actions button {
                padding: 10px;
                font-size: 1rem;
            }

            .messages-container { padding: 16px 20px; }
            .message-bubble { padding: 12px 16px; font-size: 0.9rem; }
            .input-area { padding: 12px 20px 20px 20px; }
            .input-wrapper { padding-left: 16px; }
            .input-wrapper input { padding: 12px 0; font-size: 0.9rem; }
            .input-footer { flex-direction: column; align-items: flex-start; gap: 6px; }
        }

        @media (max-width: 480px) {
            .message { gap: 10px; }
            .message-avatar { width: 32px; height: 32px; font-size: 0.9rem; }
            .message-content { max-width: calc(100% - 42px); }
            .message-bubble { padding: 10px 14px; font-size: 0.85rem; }
            .chat-header { padding: 10px 16px 10px 65px; }
            .messages-container { padding: 12px 16px; }
            .input-wrapper button { width: 44px; height: 44px; font-size: 1rem; }
        }

        /* Landscape mode */
        @media (max-height: 600px) and (orientation: landscape) {
            .sidebar { overflow-y: auto; }
            .chat-header { padding: 8px 16px 8px 70px; min-height: 50px; }
            .messages-container { padding: 12px 16px; }
            .message-bubble { padding: 10px 14px; }
            .input-area { padding: 8px 16px 12px 16px; }
        }
    </style>
</head>
<body data-theme="dark">
    <div class="app">
        <!-- ========== MENU BUTTON - TOP LEFT ========== -->
        <button class="menu-button" id="menuButton" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>

        <!-- ========== SIDEBAR BACKDROP ========== -->
        <div class="sidebar-backdrop" id="sidebarBackdrop" onclick="toggleSidebar()"></div>

        <!-- ========== SIDEBAR ========== -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-flask"></i>
                </div>
                <h1>KRYNOX42</h1>
            </div>

            <button class="new-chat-btn" onclick="createNewChat(); if(window.innerWidth <= 768) toggleSidebar();">
                <i class="fas fa-plus"></i>
                <span>New chat</span>
            </button>

            <div class="chat-history">
                <div class="chat-history-title">
                    <span><i class="far fa-clock"></i> Recent chats</span>
                    <span id="chatCount"></span>
                </div>
                <div class="chat-history-list" id="chatHistoryList"></div>
            </div>

            <div class="sidebar-footer">
                <div class="theme-toggle">
                    <span><i class="fas fa-moon"></i> Dark mode</span>
                    <button onclick="toggleTheme()" id="themeToggleBtn">
                        <i class="fas fa-sun"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- ========== MAIN CHAT ========== -->
        <main class="main">
            <div class="chat-header">
                <div class="chat-header-info">
                    <h2>KRYNOX42 ¬∑ Chemistry AI</h2>
                    <h3>
                        <i class="fas fa-circle" style="font-size: 0.5rem;"></i>
                        <span id="currentChatTitle">Select a chat</span>
                    </h3>
                </div>
                <div class="chat-actions">
                    <button onclick="copyAllChat()" title="Copy conversation">
                        <i class="far fa-copy"></i>
                        <span>Copy</span>
                    </button>
                    <button onclick="clearCurrentChat()" title="Clear chat">
                        <i class="far fa-trash-alt"></i>
                        <span>Clear</span>
                    </button>
                </div>
            </div>

            <div class="messages-container" id="messagesContainer">
                <div class="messages-wrapper" id="chatMessages">
                    <!-- Messages go here -->
                </div>
            </div>

            <div class="input-area">
                <div class="input-wrapper">
                    <input type="text" id="questionInput" 
                           placeholder="Ask about chemistry... (English or Kiswahili)"
                           autocomplete="off"
                           onkeypress="if(event.key === 'Enter') sendMessage()">
                    <button id="sendBtn" onclick="sendMessage()">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                </div>
                <div class="input-footer">
                    <span><i class="fas fa-atom"></i> Chemical formulas supported (H‚ÇÇO, CO‚ÇÇ)</span>
                    <span><i class="fas fa-language"></i> English ¬∑ Kiswahili</span>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ---------- CONFIG ----------
        const API_URL = "https://krynox42.abubakarali1886.workers.dev";
        
        // ---------- STATE ----------
        let chats = [];
        let currentChatId = null;
        let isTyping = false;

        // ---------- SIDEBAR TOGGLE ----------
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('sidebarBackdrop');
            const menuBtn = document.getElementById('menuButton');
            
            sidebar.classList.toggle('open');
            backdrop.classList.toggle('active');
            
            // Change icon based on state
            if (sidebar.classList.contains('open')) {
                menuBtn.innerHTML = '<i class="fas fa-times"></i>';
            } else {
                menuBtn.innerHTML = '<i class="fas fa-bars"></i>';
            }
        }

        // Close sidebar on window resize if open
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                const sidebar = document.getElementById('sidebar');
                const backdrop = document.getElementById('sidebarBackdrop');
                sidebar.classList.remove('open');
                backdrop.classList.remove('active');
                document.getElementById('menuButton').innerHTML = '<i class="fas fa-bars"></i>';
            }
        });

        // ---------- INITIALIZE ----------
        function loadChats() {
            const saved = localStorage.getItem('krynox42_chats');
            if (saved) {
                try {
                    chats = JSON.parse(saved);
                } catch (e) {
                    chats = [];
                }
            }
            
            if (chats.length === 0) {
                createNewChat();
            } else {
                // Sort by most recent
                chats.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                currentChatId = chats[0].id;
                renderChatHistory();
                loadChatMessages(currentChatId);
                updateCurrentChatTitle();
            }
        }

        // ---------- SAVE ----------
        function saveChats() {
            localStorage.setItem('krynox42_chats', JSON.stringify(chats));
            renderChatHistory();
        }

        // ---------- CREATE NEW CHAT ----------
        function createNewChat() {
            const newChat = {
                id: Date.now().toString(),
                title: 'New conversation',
                messages: [{
                    type: 'bot',
                    content: `### üëã Hello! I'm KRYNOX42, your chemistry AI tutor.

I can help you with **chemistry concepts** in both English and Kiswahili.

**How to use me:**
‚Ä¢ Ask in **English** ‚Üí I'll reply in English
‚Ä¢ Ask in **Kiswahili** ‚Üí I'll reply in Kiswahili

**Try asking:**
‚Ä¢ "Explain atomic structure"
‚Ä¢ "Eleza muundo wa atomi"
‚Ä¢ "What is pH?"
‚Ä¢ "Ni nini pH?"

What would you like to learn today? üî¨`,
                    timestamp: new Date().toISOString()
                }],
                timestamp: new Date().toISOString()
            };
            
            chats.unshift(newChat);
            currentChatId = newChat.id;
            saveChats();
            loadChatMessages(currentChatId);
            updateCurrentChatTitle();
        }

        // ---------- SWITCH CHAT ----------
        function switchChat(chatId) {
            currentChatId = chatId;
            loadChatMessages(chatId);
            renderChatHistory();
            updateCurrentChatTitle();
            
            // Close sidebar on mobile after selecting a chat
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

        // ---------- DELETE CHAT ----------
        function deleteChat(chatId, event) {
            event.stopPropagation();
            
            if (chats.length === 1) {
                // Clear instead of delete
                const chat = chats.find(c => c.id === chatId);
                if (chat) {
                    chat.messages = [{
                        type: 'bot',
                        content: `### üëã Hello! I'm KRYNOX42, your chemistry AI tutor.

I can help you with **chemistry concepts** in both English and Kiswahili.

**How to use me:**
‚Ä¢ Ask in **English** ‚Üí I'll reply in English
‚Ä¢ Ask in **Kiswahili** ‚Üí I'll reply in Kiswahili

What would you like to learn today? üî¨`,
                        timestamp: new Date().toISOString()
                    }];
                    chat.title = 'New conversation';
                    chat.timestamp = new Date().toISOString();
                    saveChats();
                    loadChatMessages(chatId);
                }
            } else {
                const index = chats.findIndex(c => c.id === chatId);
                if (index !== -1) {
                    chats.splice(index, 1);
                    if (currentChatId === chatId) {
                        currentChatId = chats[0].id;
                        loadChatMessages(currentChatId);
                    }
                    saveChats();
                }
            }
            updateCurrentChatTitle();
        }

        // ---------- CLEAR CURRENT CHAT ----------
        function clearCurrentChat() {
            if (!currentChatId) return;
            const chat = chats.find(c => c.id === currentChatId);
            if (chat) {
                chat.messages = [{
                    type: 'bot',
                    content: `### üëã Hello! I'm KRYNOX42, your chemistry AI tutor.

I can help you with **chemistry concepts** in both English and Kiswahili.

**How to use me:**
‚Ä¢ Ask in **English** ‚Üí I'll reply in English
‚Ä¢ Ask in **Kiswahili** ‚Üí I'll reply in Kiswahili

What would you like to learn today? üî¨`,
                    timestamp: new Date().toISOString()
                }];
                chat.timestamp = new Date().toISOString();
                saveChats();
                loadChatMessages(currentChatId);
            }
        }

        // ---------- RENDER CHAT HISTORY ----------
        function renderChatHistory() {
            const list = document.getElementById('chatHistoryList');
            const countSpan = document.getElementById('chatCount');
            
            list.innerHTML = '';
            if (chats.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-tertiary);">No chats yet</div>';
                return;
            }
            
            countSpan.textContent = chats.length;
            
            chats.slice(0, 20).forEach(chat => {
                const lastMsg = chat.messages[chat.messages.length - 1];
                const preview = lastMsg ? 
                    (lastMsg.type === 'user' ? 'You: ' : '') + 
                    (lastMsg.content.substring(0, 40) + (lastMsg.content.length > 40 ? '...' : ''))
                    : '';
                
                const date = new Date(chat.timestamp);
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                let timeStr;
                if (date.toDateString() === today.toDateString()) {
                    timeStr = 'Today';
                } else if (date.toDateString() === yesterday.toDateString()) {
                    timeStr = 'Yesterday';
                } else {
                    timeStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
                
                const item = document.createElement('div');
                item.className = `chat-item ${chat.id === currentChatId ? 'active' : ''}`;
                item.onclick = () => switchChat(chat.id);
                
                item.innerHTML = `
                    <div class="chat-item-icon">
                        <i class="fas fa-${chat.messages.length > 1 ? 'comment' : 'plus'}"></i>
                    </div>
                    <div class="chat-item-content">
                        <div class="chat-item-title">${chat.title}</div>
                        <div class="chat-item-meta">
                            <span class="chat-item-time">
                                <i class="far fa-calendar"></i> ${timeStr}
                            </span>
                            <span>¬∑</span>
                            <span>${chat.messages.length} msgs</span>
                        </div>
                    </div>
                    <button class="chat-item-delete" onclick="deleteChat('${chat.id}', event)">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                list.appendChild(item);
            });
        }

        // ---------- LOAD CHAT MESSAGES ----------
        function loadChatMessages(chatId) {
            const chat = chats.find(c => c.id === chatId);
            if (!chat) return;
            
            const wrapper = document.getElementById('chatMessages');
            wrapper.innerHTML = '';
            
            chat.messages.forEach(msg => {
                wrapper.appendChild(createMessageElement(msg));
            });
            
            scrollToBottom();
            
            // Render math
            if (window.renderMathInElement) {
                renderMathInElement(wrapper, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
        }

        // ---------- CREATE MESSAGE ELEMENT ----------
        function createMessageElement(msg) {
            const div = document.createElement('div');
            div.className = `message ${msg.type}`;
            
            const time = new Date(msg.timestamp).toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            // Detect language for tag
            let langTag = '';
            if (msg.type === 'bot') {
                const isSw = /[√°√©√≠√≥√∫√†√¢√™√Æ√¥√ª]|habari|asante|tafadhali|kiswahili|ni nini|eleza|maana|kemia|atomu|molekuli/i.test(msg.content);
                langTag = `<span class="message-lang">${isSw ? 'SW' : 'EN'}</span>`;
            }
            
            // Format content
            let content = msg.content
                .replace(/\b([A-Z][a-z]?\d+)/g, (match) => {
                    return match.replace(/\d+/g, (num) => `<sub>${num}</sub>`);
                })
                .replace(/### (.*?)(?:\n|$)/g, '<h3 style="font-size:1.1rem; margin-bottom:8px;">$1</h3>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
            
            div.innerHTML = `
                <div class="message-avatar">
                    <i class="fas ${msg.type === 'user' ? 'fa-user' : 'fa-flask'}"></i>
                </div>
                <div class="message-content">
                    <div class="message-bubble">
                        ${content}
                    </div>
                    <div class="message-meta">
                        <span>${time}</span>
                        ${langTag}
                    </div>
                </div>
            `;
            
            return div;
        }

        // ---------- SEND MESSAGE ----------
        async function sendMessage() {
            const input = document.getElementById('questionInput');
            const question = input.value.trim();
            if (!question || isTyping || !currentChatId) return;
            
            const chat = chats.find(c => c.id === currentChatId);
            if (!chat) return;
            
            // Add user message
            const userMsg = {
                type: 'user',
                content: question,
                timestamp: new Date().toISOString()
            };
            chat.messages.push(userMsg);
            
            // Update title if first message
            if (chat.messages.filter(m => m.type === 'user').length === 1) {
                chat.title = question.substring(0, 40) + (question.length > 40 ? '...' : '');
            }
            
            chat.timestamp = new Date().toISOString();
            saveChats();
            loadChatMessages(currentChatId);
            updateCurrentChatTitle();
            
            input.value = '';
            
            // Disable input
            document.getElementById('sendBtn').disabled = true;
            isTyping = true;
            showTypingIndicator();
            
            try {
                // Detect language
                const isSwahili = /[√°√©√≠√≥√∫√†√¢√™√Æ√¥√ª]|habari|asante|tafadhali|ni nini|eleza|maana|kiswahili|je |vipi|kemia|atomu|molekuli/i.test(question);
                
                const langInstruction = isSwahili 
                    ? "IMPORTANT: The user asked in Swahili. You MUST respond in SWAHILI (Kiswahili). Use proper chemistry terms."
                    : "IMPORTANT: Respond in ENGLISH. Use proper chemistry terminology.";
                
                const prompt = `[System] You are KRYNOX42, an expert chemistry professor. ${langInstruction}

Question: ${question}

Answer:`;
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: prompt })
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                removeTypingIndicator();
                
                const botMsg = {
                    type: 'bot',
                    content: data.answer || 'Sorry, I could not find an answer.',
                    timestamp: new Date().toISOString()
                };
                chat.messages.push(botMsg);
                chat.timestamp = new Date().toISOString();
                saveChats();
                loadChatMessages(currentChatId);
                
            } catch (error) {
                removeTypingIndicator();
                const errorMsg = {
                    type: 'bot',
                    content: `‚ùå **Connection error**: ${error.message}`,
                    timestamp: new Date().toISOString()
                };
                chat.messages.push(errorMsg);
                saveChats();
                loadChatMessages(currentChatId);
            } finally {
                document.getElementById('sendBtn').disabled = false;
                isTyping = false;
            }
        }

        // ---------- TYPING INDICATOR ----------
        function showTypingIndicator() {
            const wrapper = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-flask"></i>
                </div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            wrapper.appendChild(typingDiv);
            scrollToBottom();
        }
        
        function removeTypingIndicator() {
            document.getElementById('typingIndicator')?.remove();
        }

        // ---------- COPY ALL ----------
        function copyAllChat() {
            const chat = chats.find(c => c.id === currentChatId);
            if (!chat) return;
            
            let text = '';
            chat.messages.forEach(m => {
                text += `${m.type === 'user' ? 'üë§ You' : 'üß™ KRYNOX42'}: ${m.content}\n\n`;
            });
            navigator.clipboard.writeText(text);
            showToast('Conversation copied');
        }

        // ---------- TOAST ----------
        function showToast(msg) {
            const toast = document.createElement('div');
            toast.textContent = msg;
            toast.style.cssText = `
                position: fixed;
                top: 24px;
                right: 24px;
                background: var(--bg-elevated);
                color: var(--text-primary);
                padding: 12px 24px;
                border-radius: 40px;
                font-size: 0.9rem;
                font-weight: 500;
                box-shadow: var(--shadow-lg);
                z-index: 1001;
                border: 1px solid var(--border-light);
                animation: slideIn 0.2s;
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ---------- UTILITIES ----------
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }
        
        function updateCurrentChatTitle() {
            const chat = chats.find(c => c.id === currentChatId);
            if (chat) {
                document.getElementById('currentChatTitle').textContent = chat.title;
            }
        }

        // ---------- THEME ----------
        function toggleTheme() {
            const body = document.body;
            const current = body.getAttribute('data-theme') || 'dark';
            const newTheme = current === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('krynox42_theme', newTheme);
            
            const btn = document.getElementById('themeToggleBtn');
            btn.innerHTML = newTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        }
        
        function loadTheme() {
            const saved = localStorage.getItem('krynox42_theme');
            if (saved) {
                document.body.setAttribute('data-theme', saved);
                const btn = document.getElementById('themeToggleBtn');
                btn.innerHTML = saved === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            }
        }

        // ---------- INIT ----------
        window.addEventListener('load', () => {
            loadTheme();
            loadChats();
            
            // Add animation style
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        });

        // Expose functions globally
        window.createNewChat = createNewChat;
        window.switchChat = switchChat;
        window.deleteChat = deleteChat;
        window.clearCurrentChat = clearCurrentChat;
        window.copyAllChat = copyAllChat;
        window.toggleTheme = toggleTheme;
        window.sendMessage = sendMessage;
        window.toggleSidebar = toggleSidebar;
    </script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
</body>
</html>